<template>

    <div class="pb-6 border-b-2 border-dashed border-[#F94B65] md:col-span-6 space-y-4">
        <div class="relative overflow-hidden rounded-lg">
            <div
                class="text-white text-[12px] px-2 py-0 bg-black/60 font-semibold absolute top-0 left-0 rounded-br-lg z-999">
                <span>{{ date }}</span>
            </div>
            <video :src="vidURL + '#t=1'" class="aspect-video rounded-lg" controls></video>

            <!-- save button -->
            <div @click.stop="saveMusic({ file_url: vidURL, id: id })"
                :class="[savedAt || progress === 100 ? 'bg-[#51F94B]' : 'bg-[#F94B65] cursor-pointer hover:bg-[#F94B65]/80 transition']"
                class="flex items-center gap-2 absolute top-0 right-0 px-2 py-1 rounded-bl-lg group">
                <div class="w-3 h-3">
                    <svg v-if="savedAt || progress === 100" width="16" height="11" viewBox="0 0 16 11" fill="none"
                        xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M12.9882 4.58333C13.0824 4.30833 13.1765 4.03333 13.1765 3.66667C13.1765 1.65 11.4824 0 9.41176 0C8 0 6.68235 0.825 6.11765 2.01667C5.83529 1.925 5.45882 1.83333 5.17647 1.83333C3.85882 1.83333 2.82353 2.84167 2.82353 4.125C2.82353 4.30833 2.82353 4.49167 2.91765 4.58333C1.22353 4.85833 0 6.14167 0 7.79167C0 9.53333 1.50588 11 3.29412 11H12.7059C14.4941 11 16 9.53333 16 7.79167C16 6.14167 14.6824 4.76667 12.9882 4.58333ZM7.05882 9.99167L4.04706 7.05833L5.36471 5.775L7.05882 7.425L10.6353 3.94167L11.9529 5.225L7.05882 9.99167Z"
                            fill="white" />
                    </svg>
                    <svg v-else class="w-full h-full" viewBox="0 0 16 16" fill="none"
                        xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M8.88877 7.24444V0.888889C8.88877 0.653141 8.79512 0.427048 8.62843 0.260349C8.46173 0.0936505 8.23563 0 7.99989 0C7.76414 0 7.53805 0.0936505 7.37135 0.260349C7.20465 0.427048 7.111 0.653141 7.111 0.888889V7.24444L5.13766 4.77689C5.06615 4.68169 4.97624 4.60183 4.87326 4.54205C4.77029 4.48227 4.65636 4.44379 4.53823 4.42889C4.4201 4.41398 4.30018 4.42297 4.18559 4.4553C4.07099 4.48763 3.96407 4.54266 3.87115 4.61711C3.77823 4.69157 3.70122 4.78393 3.64468 4.88872C3.58815 4.9935 3.55324 5.10858 3.54203 5.22712C3.53083 5.34566 3.54355 5.46524 3.57944 5.57877C3.61534 5.69229 3.67368 5.79745 3.751 5.888L7.30655 10.3324C7.38984 10.4363 7.49538 10.52 7.61539 10.5776C7.73539 10.6352 7.86679 10.6651 7.99989 10.6651C8.13298 10.6651 8.26438 10.6352 8.38439 10.5776C8.50439 10.52 8.60993 10.4363 8.69322 10.3324L12.2488 5.888C12.3261 5.79745 12.3844 5.69229 12.4203 5.57877C12.4562 5.46524 12.4689 5.34566 12.4577 5.22712C12.4465 5.10858 12.4116 4.9935 12.3551 4.88872C12.2986 4.78393 12.2215 4.69157 12.1286 4.61711C12.0357 4.54266 11.9288 4.48763 11.8142 4.4553C11.6996 4.42297 11.5797 4.41398 11.4615 4.42889C11.3434 4.44379 11.2295 4.48227 11.1265 4.54205C11.0235 4.60183 10.9336 4.68169 10.8621 4.77689L8.88877 7.24444Z"
                            fill="white" />
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M5.91733 11.4436L3.87378 8.88892H1.77778C1.30628 8.88892 0.854097 9.07622 0.520699 9.40962C0.187301 9.74301 0 10.1952 0 10.6667V14.2222C0 14.6937 0.187301 15.1459 0.520699 15.4793C0.854097 15.8127 1.30628 16 1.77778 16H14.2222C14.6937 16 15.1459 15.8127 15.4793 15.4793C15.8127 15.1459 16 14.6937 16 14.2222V10.6667C16 10.1952 15.8127 9.74301 15.4793 9.40962C15.1459 9.07622 14.6937 8.88892 14.2222 8.88892H12.1262L10.0818 11.4436C9.83195 11.7558 9.51509 12.0079 9.15466 12.1811C8.79423 12.3543 8.39945 12.4443 7.99956 12.4443C7.59966 12.4443 7.20489 12.3543 6.84445 12.1811C6.48402 12.0079 6.16716 11.7558 5.91733 11.4436ZM12.4444 11.5556C12.2087 11.5556 11.9826 11.6492 11.8159 11.8159C11.6492 11.9826 11.5556 12.2087 11.5556 12.4445C11.5556 12.6802 11.6492 12.9063 11.8159 13.073C11.9826 13.2397 12.2087 13.3334 12.4444 13.3334H12.4533C12.6891 13.3334 12.9152 13.2397 13.0819 13.073C13.2486 12.9063 13.3422 12.6802 13.3422 12.4445C13.3422 12.2087 13.2486 11.9826 13.0819 11.8159C12.9152 11.6492 12.6891 11.5556 12.4533 11.5556H12.4444Z"
                            fill="white" />
                    </svg>

                </div>
                <span class="text-white text-sm font-medium">{{ savedAt || progress == 100 ? "SAVED" : 'Save' }}{{
                    progress > 0 && progress < 100 ? `Saving ${progress}%` : '' }}</span>
            </div>
        </div>

        <div class="mt-4 flex justify-between items-center">
            <div class="flex justify-end gap-3">
                <div v-if="links.youtube">
                    <!-- Youtube -->
                    <svg width="28" height="20" viewBox="0 0 28 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_39_2906)">
                            <path
                                d="M27.3816 3.11944C27.221 2.51651 26.9077 1.96683 26.473 1.52514C26.0382 1.08346 25.4971 0.765179 24.9036 0.602C22.7308 0 13.9858 0 13.9858 0C13.9858 0 5.2404 0.0182222 3.06755 0.620222C2.47403 0.783411 1.93294 1.10171 1.49818 1.54341C1.06341 1.98512 0.750139 2.53482 0.589552 3.13778C-0.0676821 7.05978 -0.322635 13.036 0.607599 16.8011C0.768202 17.404 1.08148 17.9537 1.51625 18.3954C1.95101 18.8371 2.49209 19.1554 3.0856 19.3186C5.25844 19.9206 14.0036 19.9206 14.0036 19.9206C14.0036 19.9206 22.7487 19.9206 24.9214 19.3186C25.515 19.1554 26.0561 18.8371 26.4909 18.3954C26.9256 17.9538 27.2389 17.4041 27.3996 16.8011C28.0928 12.8736 28.3064 6.901 27.3816 3.11944Z"
                                fill="#FF0000" />
                            <path d="M11.2024 14.2287L18.457 9.96007L11.2024 5.69141V14.2287Z" fill="white" />
                        </g>
                        <defs>
                            <clipPath id="clip0_39_2906">
                                <rect width="28" height="20" fill="white" />
                            </clipPath>
                        </defs>
                    </svg>
                </div>
                <!-- telegram -->
                <div v-if="links.telegram">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_39_2903)">
                            <path
                                d="M12 0C8.81812 0 5.76375 1.26506 3.51562 3.51469C1.2652 5.76522 0.000643966 8.81734 0 12C0 15.1813 1.26562 18.2357 3.51562 20.4853C5.76375 22.7349 8.81812 24 12 24C15.1819 24 18.2362 22.7349 20.4844 20.4853C22.7344 18.2357 24 15.1813 24 12C24 8.81869 22.7344 5.76431 20.4844 3.51469C18.2362 1.26506 15.1819 0 12 0Z"
                                fill="url(#paint0_linear_39_2903)" />
                            <path
                                d="M5.43184 11.873C8.93059 10.349 11.2631 9.3443 12.4293 8.8588C15.7631 7.47261 16.455 7.23186 16.9068 7.2237C17.0062 7.22211 17.2275 7.24667 17.3718 7.36339C17.4918 7.46183 17.5256 7.59495 17.5425 7.68842C17.5575 7.7818 17.5781 7.99461 17.5612 8.16074C17.3812 10.0582 16.5993 14.6629 16.2018 16.7882C16.035 17.6874 15.7031 17.9889 15.3825 18.0184C14.685 18.0825 14.1562 17.5579 13.4812 17.1155C12.4256 16.4231 11.8293 15.9922 10.8037 15.3167C9.61872 14.5359 10.3875 14.1067 11.0625 13.4055C11.2387 13.2219 14.31 10.4291 14.3681 10.1758C14.3756 10.1441 14.3831 10.026 14.3118 9.96373C14.2425 9.9013 14.1393 9.92267 14.0643 9.93955C13.9575 9.96355 12.2718 11.0788 9.00184 13.2851C8.52372 13.614 8.09059 13.7743 7.70059 13.7659C7.27309 13.7567 6.44809 13.5236 5.83497 13.3245C5.08497 13.0802 4.48684 12.951 4.53934 12.536C4.56559 12.32 4.86372 12.099 5.43184 11.873Z"
                                fill="white" />
                        </g>
                        <defs>
                            <linearGradient id="paint0_linear_39_2903" x1="1200" y1="0" x2="1200" y2="2400"
                                gradientUnits="userSpaceOnUse">
                                <stop stop-color="#2AABEE" />
                                <stop offset="1" stop-color="#229ED9" />
                            </linearGradient>
                            <clipPath id="clip0_39_2903">
                                <rect width="24" height="24" fill="white" />
                            </clipPath>
                        </defs>
                    </svg>
                </div>
                <!-- facebook -->
                <div v-if="links.facebook">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_39_2900)">
                            <path
                                d="M24 12C24 5.37262 18.6274 0 12 0C5.37262 0 0 5.37262 0 12C0 17.9895 4.38825 22.954 10.125 23.8542V15.4688H7.07812V12H10.125V9.35625C10.125 6.34875 11.9166 4.6875 14.6576 4.6875C15.9705 4.6875 17.3438 4.92188 17.3438 4.92188V7.875H15.8306C14.3399 7.875 13.875 8.80003 13.875 9.74906V12H17.2031L16.6711 15.4688H13.875V23.8542C19.6117 22.954 24 17.9896 24 12Z"
                                fill="#1877F2" />
                            <path
                                d="M16.6711 15.4688L17.2031 12H13.875V9.74906C13.875 8.79994 14.3399 7.875 15.8306 7.875H17.3438V4.92188C17.3438 4.92188 15.9705 4.6875 14.6575 4.6875C11.9166 4.6875 10.125 6.34875 10.125 9.35625V12H7.07812V15.4688H10.125V23.8542C10.7453 23.9514 11.3722 24.0001 12 24C12.6278 24.0001 13.2547 23.9514 13.875 23.8542V15.4688H16.6711Z"
                                fill="white" />
                        </g>
                        <defs>
                            <clipPath id="clip0_39_2900">
                                <rect width="24" height="24" fill="white" />
                            </clipPath>
                        </defs>
                    </svg>
                </div>

            </div>

            <!-- Type tag -->
            <div class="pb-1 border-b border-[#F94B65]">
                <span class="text-[#F94B65] text-[12px] font-bold">PLAYS</span>
            </div>
        </div>

        <div class="flex items-center gap-2 py-1">
            <div>
                <!-- title -->
                <svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M13.9999 2.5V10.8333C13.9999 11.4522 13.7541 12.0457 13.3165 12.4832C12.8789 12.9208 12.2854 13.1667 11.6666 13.1667C11.0477 13.1667 10.4543 12.9208 10.0167 12.4832C9.57909 12.0457 9.33325 11.4522 9.33325 10.8333C9.33325 10.2145 9.57909 9.621 10.0167 9.18342C10.4543 8.74583 11.0477 8.5 11.6666 8.5C12.0266 8.5 12.3666 8.58 12.6666 8.72667V4.81333L5.99992 6.23333V12.1667C5.99992 12.7855 5.75409 13.379 5.3165 13.8166C4.87892 14.2542 4.28542 14.5 3.66659 14.5C3.04775 14.5 2.45425 14.2542 2.01667 13.8166C1.57908 13.379 1.33325 12.7855 1.33325 12.1667C1.33325 11.5478 1.57908 10.9543 2.01667 10.5168C2.45425 10.0792 3.04775 9.83333 3.66659 9.83333C4.02659 9.83333 4.36659 9.91333 4.66659 10.06V4.5L13.9999 2.5Z"
                        fill="white" />
                </svg>


            </div>
            <span class="text-sm text-white font-semibold tracking-wider">{{ title }}</span>
        </div>



        <!-- # tags -->
        <div class="flex gap-2 items-center flex-wrap mt-4 mx-4 text-[#F94B65] text-[12px] font-semibold">
            <div v-for="(tag, index) in tags">
                <span>{{ tag }}</span>
            </div>

        </div>
    </div>

</template>


<script setup>
import { defineProps, onBeforeUnmount, onMounted, ref } from 'vue';

const props = defineProps({
    id: Number,
    date: String,
    vidURL: String,
    vidType: String,
    tags: Array,
    title: String,
    links: Object,
    savedAt: Number || undefined
})

const progress = ref(0);

function saveMusic(music) {
    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {

        console.log("Click Save music: ", music.id);

        navigator.serviceWorker.controller.postMessage({
            type: 'SAVE_MUSIC',
            payload: music,
        })
        progress.value = 0
    } else {
        console.warn('Service worker not active')
    }
}

// âœ… Listen for progress updates
function handleSWMessage(event) {
    const { type, progress: pct, musicId } = event.data || {}

    if (type === 'SAVE_PROGRESS' && musicId === props.id) {
        progress.value = pct
    }
    if (type === 'SAVE_DONE' && musicId === props.id) {
        progress.value = 100
    }
}

onMounted(() => {
    navigator.serviceWorker?.addEventListener('message', handleSWMessage)
})
onBeforeUnmount(() => {
    navigator.serviceWorker?.removeEventListener('message', handleSWMessage)
})
</script>